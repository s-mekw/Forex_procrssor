# [Phase 1] MT5データ取得層とDashテストUIの実装

## 概要

Route to Botter Gammaのインクリメンタル開発の第一段階として、MT5からのリアルタイムデータ取得機能と、そのデータを表示する簡易的なDashウェブアプリケーションを実装します。

## 実装内容

### 1. データ取得層 (本番用)

#### `src/mt5_data_acquisition/`
- **`mt5_client.py`**: MT5への接続管理クラス
  - MT5サーバーへの接続/切断
  - 認証処理とセッション管理
  - 接続エラーハンドリング
  
- **`ohlc_fetcher.py`**: OHLC(Open/High/Low/Close)データ取得
  - リアルタイムOHLCデータの取得
  - 複数通貨ペア対応
  - 複数時間足対応 (M1, M5, M15, H1)
  - Polars DataFrameでのデータ構造化
  
- **`main.py`**: エントリーポイント
  - データ取得の開始/停止制御
  - コマンドライン引数処理
  - ログ出力とエラー監視

### 2. 共通ユーティリティ

#### `src/common/`
- **`config.py`**: 設定管理
  - 環境変数の読み込み
  - アプリケーション設定の一元管理
  - MT5接続設定
  
- **`logger.py`**: ロギング設定
  - 構造化ログ出力
  - ファイル/コンソール出力対応
  - ログレベル制御
  
- **`exceptions.py`**: カスタム例外
  - MT5接続エラー
  - データ取得エラー
  - 設定エラー

### 3. テスト用Dashアプリケーション

#### `test_dash_app/` (本番srcと分離)
- **`app.py`**: Dashアプリケーションメイン
  - リアルタイムチャート表示
  - 通貨ペア選択UI
  - 時間足選択UI
  - データ更新頻度制御
  
- **`README.md`**: テストアプリ説明書
  - 起動方法
  - 使用方法
  - 依存関係

## 技術仕様

### 技術スタック
- **Python 3.12**: メイン開発言語
- **MetaTrader5**: FXデータ取得API
- **Polars**: 高速データフレーム処理
- **Dash**: Webダッシュボードフレームワーク
- **uv**: パッケージマネージャー

### データ構造
```python
# OHLCデータフレーム構造 (Polars)
pl.DataFrame({
    "timestamp": pl.Datetime,
    "symbol": pl.Utf8,
    "timeframe": pl.Utf8,
    "open": pl.Float64,
    "high": pl.Float64,
    "low": pl.Float64,
    "close": pl.Float64,
    "volume": pl.Int64
})
```

### 接続仕様
- **MT5接続**: 環境変数による認証情報管理
- **更新頻度**: 1分間隔でのデータ取得
- **対応通貨ペア**: USD/JPY, EUR/JPY, GBP/JPY (初期実装)
- **対応時間足**: 1分足, 5分足, 15分足, 1時間足

## 実装要件

### 必須要件
- [ ] MT5への安定した接続
- [ ] リアルタイムOHLCデータ取得
- [ ] Polarsでのデータ処理
- [ ] 基本的なWebUI表示
- [ ] エラーハンドリング
- [ ] 型ヒント完備
- [ ] ログ出力

### 非機能要件
- [ ] 接続エラー時の自動復旧
- [ ] メモリ使用量の最適化
- [ ] CPU使用率の監視
- [ ] テストカバレッジ 80% 以上

## テストシナリオ

### 単体テスト
- [ ] MT5接続テスト (モック使用)
- [ ] データ取得テスト
- [ ] データ構造検証テスト
- [ ] エラーハンドリングテスト

### 統合テスト
- [ ] MT5からDashアプリまでのエンドツーエンドテスト
- [ ] リアルタイム更新テスト
- [ ] 複数通貨ペア同時処理テスト

## 成功基準

### 機能面
✅ MT5からリアルタイムでOHLCデータを取得できる  
✅ Dashアプリでチャートがリアルタイム更新される  
✅ 複数通貨ペアを選択して表示できる  
✅ エラーが発生しても自動復旧する  

### 技術面
✅ 全コードに型ヒントが付いている  
✅ Polarsを使用してデータ処理している  
✅ ログが適切に出力される  
✅ テストが実行され、全て通る  

## リスク管理

### 技術リスク
- **MT5接続不安定**: 再接続ロジック実装で対応
- **データ取得遅延**: 非同期処理での対応
- **メモリリーク**: 定期的なガベージコレクション

### 運用リスク
- **ブローカー接続問題**: 複数ブローカー対応準備
- **API制限**: レート制限の監視と制御

## 開発フェーズ

### Phase 1.1: 基盤実装 (1週間)
- 共通ユーティリティ開発
- MT5クライアント基本機能
- 基本的なテスト実装

### Phase 1.2: データ取得機能 (1週間)
- OHLC取得機能実装
- エラーハンドリング強化
- 統合テスト実装

### Phase 1.3: UI実装 (1週間)
- Dashアプリケーション開発
- リアルタイム更新機能
- エンドツーエンドテスト

### Phase 1.4: 最適化・安定化 (3日)
- パフォーマンス最適化
- エラー処理改善
- ドキュメント整備

## 次フェーズ準備

この実装により以下の基盤が整備され、Phase 2での拡張が可能になります：

- **データ処理層**: テクニカル指標計算機能の追加
- **ML層**: PatchTSTモデル統合
- **永続化層**: InfluxDBとの連携
- **本番UI**: フル機能ダッシュボードの開発

## 関連ドキュメント

- [Product Overview](.kiro/steering/product.md)
- [Technology Stack](.kiro/steering/tech.md)
- [Project Structure](.kiro/steering/structure.md)