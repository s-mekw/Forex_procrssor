# データ処理モジュール共通基盤強化の提案

## 概要
`src/mt5_data_acquisition/tick_to_bar.py`と`src/data_processing/processor.py`の分析結果に基づき、メモリ管理とエラーハンドリングの共通基盤を構築する提案です。

## 背景

### 現状の分析
1. **機能的な重複はない**
   - `tick_to_bar.py`: リアルタイムティック処理に特化
   - `processor.py`: Polarsベースのバッチ処理に特化
   - 両者は異なるレイヤーで適切に責務分離されている

2. **実装パターンの類似性**
   - メモリ管理：それぞれ独自の戦略を実装
   - エラーハンドリング：異なるアプローチを採用
   - ログ出力：統一されていない形式

### 問題点
- 同様の機能を異なる方法で実装（車輪の再発明）
- メンテナンス時の一貫性確保が困難
- 新規開発時のベストプラクティスが不明確

## 提案内容

### Phase 1: 共通基盤モジュールの作成（今回実装）

#### 1. メモリ管理モジュール (`src/common/memory_manager.py`)
```python
# 主な機能
- MemoryMonitor: システムメモリの監視
- AdaptiveChunkSize: 動的チャンクサイズ調整
- MemoryPressureHandler: メモリ圧力への対応
```

#### 2. エラーハンドリングモジュール (`src/common/error_handling.py`)
```python
# 共通例外クラス階層
- ProcessingError (基底クラス)
  - DataValidationError
  - MemoryLimitError
  - ConfigurationError
  - ConnectionError
```

#### 3. ログユーティリティ (`src/common/logging_utils.py`)
```python
# 構造化ログのヘルパー
- StructuredLogger: JSON形式の構造化ログ
- LogContext: コンテキスト情報の管理
- PerformanceLogger: パフォーマンス計測ログ
```

### Phase 2: 段階的移行（将来実装）
1. 新規開発から共通モジュールを使用
2. 既存コードは保守時に順次移行
3. 移行ガイドラインの作成

### Phase 3: インターフェース統一（将来検討）
1. データ処理パイプラインの共通インターフェース
2. プロトコルベースの疎結合設計

## 実装計画

### 1. 基本実装（優先度: 高）
- [x] 改善提案書の作成
- [ ] `memory_manager.py`の実装
- [ ] `error_handling.py`の実装
- [ ] `logging_utils.py`の実装

### 2. テスト（優先度: 高）
- [ ] 各モジュールの単体テスト作成
- [ ] 既存テストの動作確認

### 3. ドキュメント（優先度: 中）
- [ ] APIドキュメントの作成
- [ ] 使用例の作成
- [ ] 移行ガイドの作成

## 影響範囲

### 直接的な影響
- **既存コードへの影響**: なし（後方互換性を維持）
- **新規開発への影響**: 共通モジュールの使用を推奨

### 依存関係
- `tick_to_bar.py`を参照: 11ファイル
- `processor.py`を参照: 9ファイル
- テストファイル: 3ファイル
- デモファイル: 18ファイル

## 実装の利点

1. **保守性の向上**
   - コードの重複を削減
   - 一貫性のあるエラー処理
   - 統一されたログ形式

2. **拡張性の確保**
   - 新機能追加が容易
   - 共通パターンの再利用

3. **品質の向上**
   - テスト済みの共通コンポーネント
   - ベストプラクティスの共有

## リスクと対策

### リスク
1. 既存コードの破壊的変更
2. パフォーマンスの劣化
3. 学習コストの増加

### 対策
1. 後方互換性を完全に維持
2. パフォーマンステストの実施
3. 充実したドキュメントとサンプルコード

## 成功基準

1. **技術的基準**
   - 既存テストがすべてパス
   - パフォーマンスの劣化なし
   - コードカバレッジ80%以上

2. **品質基準**
   - ドキュメントの完備
   - サンプルコードの提供
   - 移行ガイドの作成

## タイムライン

- **Week 1**: 基本実装とテスト
- **Week 2**: ドキュメント作成と既存コードの部分移行
- **Week 3**: レビューと最終調整

## 結論

この提案は、既存の機能を維持しながら、将来の保守性と拡張性を向上させるための段階的なアプローチです。共通基盤の構築により、コードの品質向上と開発効率の改善が期待できます。

## 付録

### A. 現状のコード分析詳細

#### tick_to_bar.py
- 行数: 415行
- 主要クラス: TickToBarConverter
- メモリ管理: max_completed_bars による制限
- エラー処理: ValidationError、構造化ログ

#### processor.py
- 行数: 1075行
- 主要クラス: PolarsProcessingEngine
- メモリ管理: 動的チャンクサイズ調整
- エラー処理: カスタム例外クラス階層

### B. 参考資料
- [既存のcommonモジュール](../../src/common/)
- [tick_to_bar.pyのドキュメント](../../src_documentations/mt5_data_acquisition/tick_to_bar.py.md)
- [processor.pyのドキュメント](../../src_documentations/data_processing/processor.py.md)